#!/bin/bash

SERVER=$(gum choose "Dedicated_IP" "p2p" "Switzerland" "United_States")

# TODO: Allow "Other..." as a choice above and open full countries list:
# SERVER=$(nordvpn countries | sed 's/ \+/\'$'\n''/g' | gum choose)

# TODO: Rewrite as a sort of "network options" script, rather than `vpn`
#       It should have options for:
#       - Syncing files (starts dropbox daemon)
#       - General browsing (stops unneccessary daemons [e.g. Dropbox] and connects to Dedicate_IP on Nord)
#       - p2p (starts transmission daemon, jackett daemon and asks if we'd like to search [raincoat] or open stig interface)
#       - Increased privacy (connects to a VPN in a country with better user privacy [e.g. Switzerland])
#       - Listing country servers (might list some commonly used ones like United_States, but we also want to filter and select from the whole list)

[[ $SERVER == "" ]] && echo "Exiting..." && exit 1

killall dropbox
killall steam

if [[ $SERVER != "p2p" ]]; then
  systemctl stop jackett.service
	transmission-remote --exit
fi

# echo -e "Connecting to $SERVER..."
nordvpn connect $SERVER

if [[ $SERVER == "Dedicated_IP" ]]; then
  sleep 1
  dropbox 1>/dev/null 2>&1 &
fi

if [[ $SERVER == "p2p" ]]; then
  echo "Starting Transmission daemon..."
  transmission-daemon
  
  # We're also going to start the Jackett search/indexing service
  # NOTE: This requires additional permissions - to allow the user
  # to initiate the action without a password, a Polkit rule needs
  # to be created: https://wiki.archlinux.org/title/Polkit#Allow_a_user_to_use_the_org.freedesktop.timedate1.set-timezone_action
  systemctl start jackett.service

  # TODO: We should ask whether we want to search (using `raincoat [search term]`)
  #       or view active torrents (using `stig` as below).
  # NOTE: We've moved away from raincoat due to issues installing... Python package resolution issues.
  #       We're now using Cuff but it needs some work. We need to better format the options,
  #       list them in order and allow for them to be selected. Should be able to do it all with
  #       gum but it's gonna be a bit of work.
  stig
fi
